// Prisma schema for MongoDB

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  email         String    @unique
  username      String    @unique
  passwordHash  String    @map("password_hash")
  role          UserRole  @default(MEMBER)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  ideas         Idea[]
  experiments   Experiment[]       @relation("ExperimentCreator")
  experimentTeam ExperimentTeam[]
  reflections   Reflection[]
  outcomes      Outcome[]
  refreshTokens RefreshToken[]
  
  @@map("users")
}

enum UserRole {
  ADMIN
  MODERATOR
  MEMBER
  GUEST
}

model Idea {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  status      IdeaStatus @default(PROPOSED)
  createdById String     @map("created_by_id") @db.ObjectId
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  createdBy   User        @relation(fields: [createdById], references: [id])
  experiments Experiment[]
  
  @@map("ideas")
}

enum IdeaStatus {
  PROPOSED
  EXPERIMENT
  OUTCOME
  REFLECTION
  ARCHIVED
}

model Experiment {
  id            String           @id @default(auto()) @map("_id") @db.ObjectId
  title         String
  description   String
  hypothesis    String?
  status        ExperimentStatus @default(PLANNING)
  startDate     DateTime?        @map("start_date")
  endDate       DateTime?        @map("end_date")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  
  ideaId        String           @map("idea_id") @db.ObjectId
  idea          Idea             @relation(fields: [ideaId], references: [id])
  createdById   String           @map("created_by_id") @db.ObjectId
  createdBy     User             @relation("ExperimentCreator", fields: [createdById], references: [id])
  
  team          ExperimentTeam[]
  outcomes      Outcome[]
  
  @@map("experiments")
}

enum ExperimentStatus {
  PLANNING
  ACTIVE
  COMPLETED
  CANCELLED
}

model ExperimentTeam {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  experimentId  String    @map("experiment_id") @db.ObjectId
  userId        String    @map("user_id") @db.ObjectId
  role          String    @default("participant")
  joinedAt      DateTime  @default(now()) @map("joined_at")

  experiment    Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([experimentId, userId])
  @@map("experiment_team")
}

model Outcome {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  result        String
  notes         String?
  status        OutcomeStatus @default(PENDING)
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  
  experimentId  String        @map("experiment_id") @db.ObjectId
  experiment    Experiment    @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  createdById   String        @map("created_by_id") @db.ObjectId
  createdBy     User          @relation(fields: [createdById], references: [id])
  
  reflections   Reflection[]
  
  @@map("outcomes")
}

enum OutcomeStatus {
  PENDING
  SUCCESS
  FAILURE
  MIXED
  INCONCLUSIVE
}

model Reflection {
  id            String           @id @default(auto()) @map("_id") @db.ObjectId
  title         String?
  summary       String?
  whatWorked    String[]         @map("what_worked")
  whatDidntWork String[]         @map("what_didnt_work")
  surprises     String[]
  rootCauses    String?          @map("root_causes")
  keyLearnings  String[]         @map("key_learnings")
  shouldContinue Boolean?        @map("should_continue")
  improvements   String[]
  benefitedCount Int?            @map("benefited_count")
  sentiment      Sentiment?      
  reviewStatus   ReviewStatus    @default(DRAFT)
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  
  outcomeId     String           @map("outcome_id") @db.ObjectId
  outcome       Outcome          @relation(fields: [outcomeId], references: [id], onDelete: Cascade)
  authorId      String           @map("author_id") @db.ObjectId
  author        User             @relation(fields: [authorId], references: [id])
  
  @@map("reflections")
}

enum ReviewStatus {
  DRAFT
  REVIEWED
  PUBLISHED
}

enum Sentiment {
  POSITIVE
  NEUTRAL
  MIXED
  NEGATIVE
}

model RefreshToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  token     String   @unique
  userId    String   @map("user_id") @db.ObjectId
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}
